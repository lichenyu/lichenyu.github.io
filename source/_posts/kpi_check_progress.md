title: KPI Check Progress
date: 2018/10/10
categories:
- Data Analysis
tags:
- KPI Check
---


## 0. 数据预处理 ##

数据读取


## 1. 训练数据预处理 ##

### 1.1. 各天数据校验 ###

- 按天为周期尽可能多的截取训练数据。判断每个周期内缺失点的数量是否超过2%，如超过则将该周期剔除。剔除异常周期之后，如果能够用于训练的数据周期数小于阈值（4天/周），无法训练。
- 对缺失点nan，进行线性插值补点。


### 1.2. 去除异常点 ###

训练数据中（要做阈值选取）不想有异常。因而，进一步使用LOF及滤波，去除异常点。


#### [LOF] ####

- LOF的训练和测试，都是使用1.1处理后的数据，shape=（周期，时刻）。
- 对各个周期的各个时刻的点，按**窗口**提取特征（向量），nan点替换为0，最终shape=（周期，时刻，特征）。
- 训练：对各个周期、同一时刻的点，使用特征（向量）训练LOF。最终获取了各个时刻的LOF模型。
- 测试：对各个周期、同一时刻的点，特征（向量）使用该时刻LOF模型判断。


#### [滤波] ####

与降级检测的大毛刺检测是一致的（自学自检）。

- 滤波的训练和测试，都是使用1.1处理后的数据，shape为一维时间序列数据。
- 计算残差：abs(输入数据 - 滤波)；对残差计算阈值：$\mu + k \times \sigma$；残差大于阈值的，为异常点。
- 各滤波器得出的结果投票，确定检出异常点。
- 去除周期性出现的异常点。

特别的，数据的正常范围为：
{% math %}
\begin{aligned}
- (\mu + k \times \sigma) < &输入数据 - 滤波 < (\mu + k \times \sigma)\\
滤波 - (\mu + k \times \sigma) < &输入数据 < 滤波 + (\mu + k \times \sigma)
\end{aligned}
{% endmath %}


### 1.3. 去除异常点后检查 ###

- 如果（由上述两种方法检出的、并集）异常点的个数超过15%，则将异常周期剔除，否则只将异常点剔除。剔除异常周期之后，如果能够用于训练的数据周期数小于阈值（4天/周），无法训练。
- （检测周期性，确定算法）
- 线性插值（连续的异常点，线性变化），补异常点。
- 对处理后的数据进行各种滤波，保存滤波结果。
- 为FFT从原始数据中提取数据，即多取（窗口大小 - 1）个点。


## 2. 周期性检测 ##

利用自相关函数来进行判断


## 3. 异常检测 ##

处理的对象是什么？计算的指标是什么？训练获取的是什么？检测时怎么做？


### 3.1. 周期性数据 ###

#### [点对点] ####

先通过KMeans，按周期为单位将数据聚类，看看能否把数据划分为两大类。
如果能，则后续操作，对各聚类簇分别操作。

|||
|---|---|
|**对象**|各周期同一时刻的数据点|
|**处理法**|确定两个固定的阈值$\mu \pm k \times \sigma$，在此范围外的点为异常。|
|**核心思想**|周期性数据，不同天同一时刻的数据点，取值应该相差不大。|

- 按周期为单位，直接统计**原始数据**序列。
- 训练：根据训练数据（注意：训练数据都是经过滤波后的，下同），获取均值$\mu$和方差$\sigma$阈值。(以及是否划分两大类的flag)
  + 如果$\sigma$是0，就按均值的10%来设置阈值。
- 检测：检测数据，若在阈值$\mu \pm k \times \sigma$之外，则认为是异常。
  + 根据记录的各时刻点的均值$\mu$和方差$\sigma$（的均值之比），确定阈值中$k$的值。
  + 可能在训练时，数据被划分为两大类。此时，分别使用两组训练获得的$\mu$和$\sigma$，获取异常点。检测结果使用异常点数量较少的结果。
  + 若异常点连续出现，则认为检出异常，否则进行抑制。


#### [FFT] ####

|||
|---|---|
|**对象**|各周期同一时刻的数据点及其前几个点，作为时间窗|
|**处理法**|同时刻时间窗做FFT，对比序列是否来自同一分布。|
|**核心思想**|周期性数据，不同天同一时刻（时间窗）的数据点，在频域的统计分布上应该相差不大。|

- 同一时刻的数据点及其前几个点作为**时间窗**，做FFT。
- 训练与测试使用的数据，是为了FFT专门从原始数据中直接提取的数据（多了窗口长度-1个点，未去除过异常点及平滑）。先进行去除毛刺（sharp）：
  + 从第一个窗口开始（已经提前多取了窗口长度-1个点，相当于直接处理第一个数据点），计算$参考值 = \frac{原始值 - 当前窗口均值}{当前窗口标准差}$
  + $阈值 = 各窗口参考值的均值 + 3 \times 各窗口参考值的标准差$
  + 如果参考值>阈值，则该点为毛刺。使用该点作为第一个点的时间窗，通过最后三个点计算出一个数值$\frac{倒数第3点 + 2 \times 倒数第2点 + 4 \times 倒数第1点}{7}$，替换该点。
- 训练：
  + 对每个时间窗进行FFT变换，（相当于处理每个数据点，不包含提前多取的窗口长度-1个点）。
  + 各周期同一时刻的点，串联保存其归一化FFT序列的一半，即$\frac{序列值}{窗口大小}[range(\frac{窗口大小}{2})]$。这样，模型会为每个时刻保存一系列变换值，共计保存$每周期点数 \times 周期数 \times \frac{窗口大小}{2}$个FFT变换值。
- 检测：
  + 对各点做（相应窗口）FFT变换，获取其归一化FFT序列的一半。
  + 使用KS检验，与训练数据相应时刻的序列进行分布对比，得出相似度。
  + 向前10个点的相似度求和。如果相似度小于某个阈值，则认为（该点为第一个点的）整个窗口异常，记录异常点下标。
  + 若连续异常点的个数超过阈值，则判断为检出异常。注意：“连续”异常点之间，可以稍微有所差距（下标之差小于阈值），不需要严格连续。


#### [最小值] ####

|||
|---|---|
|**对象**|所有数据点|
|**处理法**|确定一个最小阈值，在此值以下的点为异常。|
|**核心思想**|（根据历史各周期情况）数据应存在一个不应被超过的下限。|

- 查找每个周期的指标最小值，并对最小值求平均，将平均值的75%或者50%作为阈值。
- 若异常点连续出现，则认为检出异常，否则进行抑制。


### 3.2. 非周期性数据 ###

#### [大毛刺] ####

|||
|---|---|
|**对象**|所有数据点|
|**处理法**|确定两个固定的阈值$滤波后数据 \pm (\mu + k \times \sigma)$，在此范围外的点为异常。|
|**核心思想**|数据变化应较为平缓。|

- 将**原始数据**与**滤波后数据**，相减并取绝对值。
- 训练：根据训练数据的残余信号的均值和方差，获取$\mu + k \times \sigma$阈值。
- 检测：检测数据的残余信号，若在阈值之外，则认为是异常。
  + 多种滤波的结果投票，确定最终检出异常。
  + 若好几个周期都在某个时刻出现异常，则认为是系统的正常波动，对该时刻的检出异常进行抑制。


#### [动态阈值] ####

|||
|---|---|
|**对象**|所有数据点|
|**处理法**|确定两个固定的阈值$\mu \pm k \times \sigma$，在此范围外的点为异常。|
|**核心思想**|各数据点间应该相差不大。|

- 直接统计**原始数据**（区别于大毛刺检测中，存在滤波平滑处理）。
- 训练：根据训练数据的均值和方差，获取$\mu \pm k \times \sigma$阈值。
  + 值为零的点不参与均值、方差的计算。 
- 检测：检测数据，若在阈值之外，则认为是异常。


### 3.3. 异常点检测方法总结 ###

从上文可以看出，在KpiCheck中，对于异常点检测，主要使用的方法就是**K-sigma准则取阈值**。

此外，还有离群点检测方法**LOF**，被用于了训练数据预处理。


### 3.4. 所谓的降级检测 ###

- 当模型不存在或主动降级检测时启动降级检测。
- 只进行大毛刺和动态阈值（自学自检，训练测试数据为同一数据集）。

